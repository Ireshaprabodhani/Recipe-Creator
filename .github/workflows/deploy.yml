name: Deploy to AWS App Runner

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and push backend
      working-directory: ./image_to_recipe
      run: |
        docker build -t backend .
        docker tag backend:latest ${{ steps.login-ecr.outputs.registry }}/recipe-backend:latest
        docker push ${{ steps.login-ecr.outputs.registry }}/recipe-backend:latest

    - name: Deploy Backend to App Runner
      run: |
        aws apprunner update-service \
          --service-arn "${{ secrets.BACKEND_APPRUNNER_SERVICE_ARN }}" \
          --source-configuration "{\"ImageRepository\":{\"ImageIdentifier\":\"${{ steps.login-ecr.outputs.registry }}/recipe-backend:latest\",\"ImageRepositoryType\":\"ECR\",\"ImageConfiguration\":{\"Port\":\"5000\",\"RuntimeEnvironmentVariables\":{\"OPENAI_API_KEY\":\"${{ secrets.OPENAI_API_KEY }}\"}}}}"

    - name: Build and push frontend
      working-directory: ./frontend
      run: |
        docker build -t frontend .
        docker tag frontend:latest ${{ steps.login-ecr.outputs.registry }}/recipe-frontend:latest
        docker push ${{ steps.login-ecr.outputs.registry }}/recipe-frontend:latest

    - name: Deploy Frontend to App Runner
      run: |
        aws apprunner update-service \
          --service-arn "${{ secrets.FRONTEND_APPRUNNER_SERVICE_ARN }}" \
          --source-configuration "{\"ImageRepository\":{\"ImageIdentifier\":\"${{ steps.login-ecr.outputs.registry }}/recipe-frontend:latest\",\"ImageRepositoryType\":\"ECR\",\"ImageConfiguration\":{\"Port\":\"80\",\"RuntimeEnvironmentVariables\":{\"VITE_API_URL\":\"${{ secrets.BACKEND_URL }}\"}}}}"